#!/bin/sh -e

expname="PhysicsExperiment-$1"
if [ -z $1 ]; then
    echo "No experiment version specified."
    exit 1
fi
echo "Deploying to '$expname'..."

curpath=`pwd`
exppath="../../experiment"
basepath="cocosci.dreamhosters.com/jhamrick/$expname"
cmd="$(which rsync) -rLtgohi --exclude=*.pyc --exclude=*~ --exclude=data --exclude=logs"

cd $exppath
exppath=`pwd`
if [ -d "data" ]; then
    echo "Cleaning data directory"
    git clean -fX -- data/
fi
if [ -d "logs" ]; then
   echo "Cleaning logs"
   git clean -fX -- logs/
fi
cd $curpath

checkip=$(grep "F_CHECK_IP = True" $exppath/index.py) || true
if [ -z "$checkip" ]; then
    color="\033[31m"
else
    color="\033[32m"
fi
echo $color$(grep "F_CHECK_IP =" $exppath/index.py)"\033[0m"

echo "Synchronizing files"
$cmd "$exppath/" cocosci:"$basepath"

hasdb=$(ssh cocosci "cd $basepath; if [ -e data/data.db ]; then echo 1; fi")
if [ -z $hasdb ]; then
    ssh cocosci "cd $basepath; python -c \"import db_tools; db_tools.create()\""
else
    echo "Database already exists, skipping"
fi

echo "Done!"
